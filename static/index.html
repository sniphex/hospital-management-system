<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hospital Management System - Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #667eea;
    --primary-dark: #5a67d8;
    --secondary: #48bb78;
    --danger: #f56565;
    --warning: #ed8936;
    --info: #4299e1;
    --light: #f7fafc;
    --dark: #2d3748;
    --gray: #718096;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding-bottom: 40px;
}

/* Header */
.header {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    padding: 20px 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 100;
    animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logo-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.logo-icon svg {
    width: 28px;
    height: 28px;
    fill: white;
}

.logo-text h1 {
    font-size: 24px;
    color: var(--dark);
    font-weight: 700;
}

.logo-text p {
    font-size: 13px;
    color: var(--gray);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-right: 15px;
    border-right: 2px solid #e2e8f0;
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--secondary), #38a169);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
}

.user-details span {
    display: block;
    font-size: 13px;
    color: var(--gray);
}

.user-details strong {
    font-size: 15px;
    color: var(--dark);
}

.logout-btn {
    padding: 10px 24px;
    background: linear-gradient(135deg, #fc8181, #f56565);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
    display: flex;
    align-items: center;
    gap: 8px;
}

.logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
}

.logout-btn svg {
    width: 18px;
    height: 18px;
    fill: white;
}

/* Container */
.container {
    max-width: 1400px;
    margin: 30px auto;
    padding: 0 30px;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s;
    animation: fadeInUp 0.6s ease-out backwards;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }
.stat-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stat-icon.patients {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.stat-icon.doctors {
    background: linear-gradient(135deg, #48bb78, #38a169);
}

.stat-icon.appointments {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.stat-icon.pending {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
}

.stat-icon svg {
    width: 30px;
    height: 30px;
    fill: white;
}

.stat-info h3 {
    font-size: 28px;
    color: var(--dark);
    font-weight: 700;
}

.stat-info p {
    font-size: 14px;
    color: var(--gray);
    margin-top: 4px;
}

/* Main Grid */
.main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
}

@media (max-width: 1024px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
}

/* Card */
.card {
    background: white;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    animation: fadeInUp 0.6s ease-out backwards;
}

.card:nth-child(1) { animation-delay: 0.5s; }
.card:nth-child(2) { animation-delay: 0.6s; }

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f7fafc;
}

.card-header svg {
    width: 24px;
    height: 24px;
    fill: var(--primary);
}

.card-header h3 {
    font-size: 20px;
    color: var(--dark);
    font-weight: 700;
}

/* Form Elements */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: var(--dark);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

input, select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.3s;
    background: white;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn svg {
    width: 20px;
    height: 20px;
    fill: white;
}

.success-msg, .error-msg {
    padding: 12px;
    border-radius: 8px;
    margin-top: 15px;
    font-size: 14px;
    display: none;
}

.success-msg {
    background: #c6f6d5;
    color: #22543d;
    border: 1px solid #48bb78;
}

.error-msg {
    background: #fff5f5;
    color: #c53030;
    border: 1px solid #fc8181;
}

.success-msg.show, .error-msg.show {
    display: block;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Appointment History */
.history-card {
    grid-column: 1 / -1;
    animation: fadeInUp 0.6s ease-out 0.7s backwards;
}

.history-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box input {
    padding-left: 45px;
}

.search-box svg {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    fill: var(--gray);
}

.filter-group {
    display: flex;
    gap: 10px;
}

.filter-btn {
    padding: 10px 20px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    color: var(--gray);
}

.filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.filter-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}

.filter-btn.active:hover {
    color: white;
}

/* Table */
.table-container {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

thead {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

thead th {
    padding: 16px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

tbody tr {
    border-bottom: 1px solid #e2e8f0;
    transition: all 0.2s;
}

tbody tr:hover {
    background: #f7fafc;
}

tbody td {
    padding: 16px;
    color: var(--dark);
    font-size: 14px;
}

.status-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.booked {
    background: #c6f6d5;
    color: #22543d;
}

.status-badge.completed {
    background: #bee3f8;
    color: #2c5282;
}

.status-badge.cancelled {
    background: #fed7d7;
    color: #742a2a;
}

.action-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.action-btn.delete {
    background: linear-gradient(135deg, #fc8181, #f56565);
    color: white;
    box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
}

.action-btn.delete:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
}

.action-btn svg {
    width: 14px;
    height: 14px;
    fill: white;
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray);
}

.empty-state svg {
    width: 80px;
    height: 80px;
    fill: #cbd5e0;
    margin-bottom: 20px;
}

.empty-state h4 {
    font-size: 18px;
    margin-bottom: 8px;
}

/* Loading Spinner */
.spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.btn.loading .btn-text {
    display: none;
}

.btn.loading .spinner {
    display: block;
}

/* Responsive */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 15px;
    }

    .user-info {
        border-right: none;
        padding-right: 0;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .history-controls {
        flex-direction: column;
    }

    .search-box {
        width: 100%;
    }

    .filter-group {
        overflow-x: auto;
        padding-bottom: 10px;
    }

    table {
        font-size: 13px;
    }

    thead th, tbody td {
        padding: 12px 8px;
    }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-content">
        <div class="logo-section">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-6 14H7v-2h6v2zm3-4H7v-2h9v2zm0-4H7V7h9v2z"/>
                </svg>
            </div>
            <div class="logo-text">
                <h1>Hospital Management System</h1>
                <p>Admin Dashboard</p>
            </div>
        </div>
        <div class="header-actions">
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div class="user-details">
                    <span>Welcome,</span>
                    <strong>Administrator</strong>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <svg viewBox="0 0 24 24">
                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                </svg>
                Logout
            </button>
        </div>
    </div>
</div>

<!-- Container -->
<div class="container">
    
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon patients">
                <svg viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="totalPatients">0</h3>
                <p>Total Patients</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon doctors">
                <svg viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.20.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="totalDoctors">0</h3>
                <p>Available Doctors</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon appointments">
                <svg viewBox="0 0 24 24">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="totalAppointments">0</h3>
                <p>Total Appointments</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon pending">
                <svg viewBox="0 0 24 24">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="pendingAppointments">0</h3>
                <p>Booked Appointments</p>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
        <!-- Register Patient -->
        <div class="card">
            <div class="card-header">
                <svg viewBox="0 0 24 24">
                    <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                <h3>Register New Patient</h3>
            </div>
            <form onsubmit="register(event)">
                <div class="form-group">
                    <label for="pname">Patient Name</label>
                    <input id="pname" type="text" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label for="pemail">Email Address</label>
                    <input id="pemail" type="email" placeholder="patient@example.com" required>
                </div>
                <button type="submit" class="btn btn-primary" id="registerBtn">
                    <span class="btn-text">Register Patient</span>
                    <div class="spinner"></div>
                </button>
                <div class="success-msg" id="pmsg"></div>
            </form>
        </div>

        <!-- Book Appointment -->
        <div class="card">
            <div class="card-header">
                <svg viewBox="0 0 24 24">
                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/>
                </svg>
                <h3>Book Appointment</h3>
            </div>
            <form onsubmit="book(event)">
                <div class="form-group">
                    <label for="apatient">Patient Name</label>
                    <input id="apatient" type="text" placeholder="Enter patient name" required>
                </div>
                <div class="form-group">
                    <label for="doctor">Select Doctor</label>
                    <select id="doctor" required>
                        <option value="">Choose a doctor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="date">Appointment Date</label>
                    <input id="date" type="date" required>
                </div>
                <div class="form-group">
                    <label for="time">Appointment Time</label>
                    <input id="time" type="time" required>
                </div>
                <button type="submit" class="btn btn-primary" id="bookBtn">
                    <span class="btn-text">Book Appointment</span>
                    <div class="spinner"></div>
                </button>
                <div class="success-msg" id="amsg"></div>
            </form>
        </div>
    </div>

    <!-- Appointment History -->
    <div class="card history-card">
        <div class="card-header">
            <svg viewBox="0 0 24 24">
                <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
            </svg>
            <h3>Appointment History</h3>
        </div>
        
        <div class="history-controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by patient or doctor name..." oninput="filterAppointments()">
                <svg viewBox="0 0 24 24">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
            </div>
            <div class="filter-group">
                <button class="filter-btn active" onclick="setFilter('all')">All</button>
                <button class="filter-btn" onclick="setFilter('Booked')">Booked</button>
                <button class="filter-btn" onclick="setFilter('Completed')">Completed</button>
                <button class="filter-btn" onclick="setFilter('Cancelled')">Cancelled</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Doctor</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="hist">
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/>
                                </svg>
                                <h4>No appointments found</h4>
                                <p>Start by booking your first appointment</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
let allAppointments = [];
let currentFilter = 'all';

// Logout Function
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        window.location.href = '/logout';
    }
}

// Set minimum date to today
document.getElementById('date').min = new Date().toISOString().split('T')[0];

// Load Doctors
function loadDoctors() {
    fetch("/doctor")
        .then(r => r.json())
        .then(doctors => {
            const select = document.getElementById('doctor');
            select.innerHTML = '<option value="">Choose a doctor...</option>';
            doctors.forEach(doc => {
                select.innerHTML += `<option value="${doc.name} (${doc.specialization})">${doc.name} - ${doc.specialization}</option>`;
            });
            document.getElementById('totalDoctors').textContent = doctors.length;
        });
}

// Register Patient
function register(e) {
    e.preventDefault();
    const btn = document.getElementById('registerBtn');
    const msg = document.getElementById('pmsg');
    
    btn.disabled = true;
    btn.classList.add('loading');
    msg.classList.remove('show');
    
    fetch("/create_patient", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: document.getElementById('pname').value,
            email: document.getElementById('pemail').value
        })
    })
    .then(r => r.json())
    .then(data => {
        msg.textContent = data.message;
        msg.classList.add('show');
        document.getElementById('pname').value = '';
        document.getElementById('pemail').value = '';
        setTimeout(() => msg.classList.remove('show'), 3000);
    })
    .catch(() => {
        msg.textContent = 'Error registering patient';
        msg.classList.add('show');
    })
    .finally(() => {
        btn.disabled = false;
        btn.classList.remove('loading');
    });
}

// Book Appointment
function book(e) {
    e.preventDefault();
    const btn = document.getElementById('bookBtn');
    const msg = document.getElementById('amsg');
    
    btn.disabled = true;
    btn.classList.add('loading');
    msg.classList.remove('show');
    
    fetch("/create_appointment", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            patient: document.getElementById('apatient').value,
            doctor: document.getElementById('doctor').value,
            date: document.getElementById('date').value,
            time: document.getElementById('time').value
        })
    })
    .then(r => r.json())
    .then(data => {
        msg.textContent = data.message;
        msg.classList.add('show');
        document.getElementById('apatient').value = '';
        document.getElementById('doctor').value = '';
        document.getElementById('date').value = '';
        document.getElementById('time').value = '';
        loadHistory();
        setTimeout(() => msg.classList.remove('show'), 3000);
    })
    .catch(() => {
        msg.textContent = 'Error booking appointment';
        msg.classList.add('show');
    })
    .finally(() => {
        btn.disabled = false;
        btn.classList.remove('loading');
    });
}

// Load Appointment History
function loadHistory() {
    fetch("/appointments")
        .then(r => r.json())
        .then(appointments => {
            allAppointments = appointments;
            updateStats();
            filterAppointments();
        });
}

// Update Statistics
function updateStats() {
    const uniquePatients = new Set(allAppointments.map(a => a.patient)).size;
    const booked = allAppointments.filter(a => a.status === 'Booked').length;
    
    document.getElementById('totalPatients').textContent = uniquePatients;
    document.getElementById('totalAppointments').textContent = allAppointments.length;
    document.getElementById('pendingAppointments').textContent = booked;
}

// Filter Appointments
function filterAppointments() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    let filtered = allAppointments.filter(apt => {
        const matchesSearch = apt.patient.toLowerCase().includes(searchTerm) || 
                            apt.doctor.toLowerCase().includes(searchTerm);
        const matchesFilter = currentFilter === 'all' || apt.status === currentFilter;
        return matchesSearch && matchesFilter;
    });
    
    displayAppointments(filtered);
}

// Set Filter
function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    filterAppointments();
}

// Display Appointments
function displayAppointments(appointments) {
    const tbody = document.getElementById('hist');
    
    if (appointments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/>
                        </svg>
                        <h4>No appointments found</h4>
                        <p>Try adjusting your search or filters</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = appointments.map(apt => `
        <tr>
            <td><strong>${apt.patient}</strong></td>
            <td>${apt.doctor}</td>
            <td>${formatDate(apt.date)}</td>
            <td>${formatTime(apt.time)}</td>
            <td><span class="status-badge ${apt.status.toLowerCase()}">${apt.status}</span></td>
            <td>
                <button class="action-btn delete" onclick="deleteAppointment(${apt.id})" title="Delete Appointment">
                    <svg viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Delete
                </button>
            </td>
        </tr>
    `).join('');
}

// Delete Appointment
function deleteAppointment(appointmentId) {
    const appointment = allAppointments.find(apt => apt.id === appointmentId);
    
    if (!appointment) return;
    
    if (confirm(`Are you sure you want to delete this appointment?\n\nPatient: ${appointment.patient}\nDoctor: ${appointment.doctor}\nDate: ${formatDate(appointment.date)}\nTime: ${formatTime(appointment.time)}`)) {
        fetch("/delete_appointment", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                id: appointmentId
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.message) {
                // Reload appointments from server
                loadHistory();
                
                // Show success message
                const msg = document.createElement('div');
                msg.className = 'success-msg show';
                msg.textContent = 'Appointment deleted successfully';
                msg.style.position = 'fixed';
                msg.style.top = '80px';
                msg.style.right = '30px';
                msg.style.zIndex = '1000';
                document.body.appendChild(msg);
                
                setTimeout(() => {
                    msg.remove();
                }, 3000);
            }
        })
        .catch(() => {
            alert('Error deleting appointment. Please try again.');
        });
    }
}

// Format Date
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

// Format Time
function formatTime(timeStr) {
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const formattedHour = hour % 12 || 12;
    return `${formattedHour}:${minutes} ${ampm}`;
}

// Initialize
loadDoctors();
loadHistory();
</script>

</body>
</html>